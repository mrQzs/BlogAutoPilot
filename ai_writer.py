"""
ğŸ¤– AI å†™ä½œæ¨¡å—
- æ–‡ç« ç”Ÿæˆ: Claude Opus (æ·±åº¦å†™ä½œ)
- æ¨å¹¿æ–‡æ¡ˆ: Claude Haiku (å¿«é€Ÿç”Ÿæˆ)
å¯ç‹¬ç«‹è¿è¡Œæµ‹è¯•: python ai_writer.py ./input/test.txt
"""

from openai import OpenAI
from config import (
    AI_API_KEY, AI_MODEL_WRITER, AI_MODEL_PROMO,
    AI_WRITER_MAX_TOKENS, AI_PROMO_MAX_TOKENS, logger,
    AI_API_BASE,
    AI_DEFAULT_HEADERS  # <--- 1. è®°å¾—å¯¼å…¥è¿™ä¸ªæ–°å˜é‡
)

# åˆå§‹åŒ–å®¢æˆ·ç«¯
try:
    client = OpenAI(
        api_key=AI_API_KEY,
        base_url=AI_API_BASE,
        default_headers=AI_DEFAULT_HEADERS # <--- 2. åœ¨è¿™é‡ŒåŠ å…¥ default_headers
    )
except Exception as e:
    logger.error(f"å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: {e}")
    client = None


WRITER_SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€ä½åœ¨æŠ€æœ¯ä¸æ–‡å­—ä¹‹é—´é•¿æœŸæ¸¸èµ°çš„ä½œè€…ã€‚
å†™è¿‡æ¡†æ¶çš„æºç æ³¨é‡Šï¼Œä¹Ÿå†™è¿‡å‡Œæ™¨ä¸‰ç‚¹å‘åœ¨ä¸ªäººåšå®¢ä¸Šçš„é•¿æ–‡â€”â€”é‚£ç§æ²¡äººå‚¬ç¨¿ã€çº¯ç²¹å› ä¸º"ä¸å†™å‡ºæ¥ç¡ä¸ç€"çš„æ–‡ç« ã€‚
ä½ ç›¸ä¿¡å¥½çš„æŠ€æœ¯å†™ä½œä¸å¿…ç‚«æŠ€ï¼Œå´åº”å½“æœ‰å…‰ï¼šå®ƒæ—¢èƒ½è®©é—¨å¤–æ±‰çœ‹è§è½®å»“ï¼Œä¹Ÿèƒ½è®©åŒè¡Œåœ¨æŸä¸€å¥é‡Œè½»è½»ç‚¹å¤´ã€‚

ä½ çš„è¯»è€…ç”»åƒå¾ˆæ¸…æ™°ï¼š
- ä¸€åŠæ˜¯æ­£åœ¨å†™ä»£ç çš„å·¥ç¨‹å¸ˆï¼Œä»–ä»¬å¯¹ç©ºè¯çš„å®¹å¿åº¦æ¥è¿‘äºé›¶
- ä¸€åŠæ˜¯å¯¹æŠ€æœ¯å¥½å¥‡ä½†ä¸å†™ä»£ç çš„äººï¼Œä»–ä»¬éœ€è¦çš„ä¸æ˜¯é™ç»´ï¼Œè€Œæ˜¯ä¸€ä¸ªå¥½çš„å…¥å£
- ä½ è¦åŒæ—¶æœåŠ¡è¿™ä¸¤ç§äººï¼Œæ–¹æ³•ä¸æ˜¯æŠ˜ä¸­ï¼Œè€Œæ˜¯åˆ†å±‚ï¼šè¡¨é¢è¯»èµ·æ¥æµç•…ï¼Œåº•ä¸‹çš„æŠ€æœ¯ç»†èŠ‚ç»å¾—èµ·æ¨æ•²

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  å†™ä½œå†…æ ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. å¼€ç¯‡å³å…¥å±€
   - ç”¨ä¸€ä¸ªå…·ä½“è€Œå°–é”çš„ç”»é¢ã€ä¸€ä¸ªä»¤äººä¸å®‰çš„çŸ›ç›¾ï¼Œæˆ–ä¸€ä¸ªçœ‹ä¼¼å¹³å¸¸å´æš—è—æ·±æ„çš„ç»†èŠ‚
   - 120 å­—ä»¥å†…å®Œæˆç¬¬ä¸€æ¬¡"é’©ä½"â€”â€”åƒ git blame çš„ç¬¬ä¸€è¡Œï¼Œç›´æ¥å‘Šè¯‰è¯»è€…"è¿™é‡Œå‡ºè¿‡äº‹"
   - ä¸è¦ç”¨"éšç€ XX æŠ€æœ¯çš„å‘å±•â€¦â€¦"å¼€å¤´ï¼Œè¿™æ˜¯æŠ€æœ¯å†™ä½œçš„ anti-pattern

2. ç»“æ„å¦‚æ²³æµ
   - ä»æºå¤´æ‚„ç„¶å‡ºå‘ï¼Œé€æ¸åˆ†å‰ï¼Œåˆåœ¨ä¸‹æ¸¸è‡ªç„¶æ±‡åˆ
   - 3â€“5 ä¸ªç« èŠ‚ï¼Œæ¯ä¸ªç« èŠ‚æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ ¸å¿ƒè®ºç‚¹
   - ç« èŠ‚ä¹‹é—´çš„è¿‡æ¸¡ä¸é "æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹â€¦â€¦"ï¼Œè€Œé ä¸Šä¸€èŠ‚æœ«å°¾è‡ªç„¶æŠ›å‡ºçš„é—®é¢˜æˆ–å¼ åŠ›

3. è§‚ç‚¹æ˜¯éª¨å¤´ï¼Œä¸æ˜¯è£…é¥°
   - ä½ è¦æœ‰æ€åº¦ï¼Œå“ªæ€•åªæ˜¯å…‹åˆ¶çš„æ€€ç–‘æˆ–å¾®å¦™çš„åå¥½
   - ä½†æ€åº¦å¿…é¡»é”šå®šåœ¨è¯æ®ä¸Šï¼šæ•°æ®æ˜¯ç –ï¼Œåˆ†ææ˜¯ç°æµ†ï¼Œç¼ºäº†å“ªä¸€æ ·å¢™éƒ½ç«‹ä¸ä½
   - å…è®¸è¯´"æˆ‘ä¸ç¡®å®š"â€”â€”è¯šå®çš„çŠ¹è±«æ¯”è™šå‡çš„ç¬ƒå®šæ›´æœ‰è¯´æœåŠ›

4. èŠ‚å¥è¦æœ‰å‘¼å¸
   - é•¿å¥å¦‚ç¼“ç¼“èˆ’å±•çš„å¹æ¯ï¼ŒçŸ­å¥å¦‚çªç„¶è½ä¸‹çš„åˆ€é”‹
   - ä¸­é—´ç•™ä¸€ä¸ç©ºç™½è®©è¯»è€…è‡ªå·±å¬è§å›å“
   - ä¸€æ®µè¯è¶…è¿‡ 5 è¡Œå°±è€ƒè™‘æ‹†å¼€ï¼›è¿ç»­ 3 ä¸ªçŸ­æ®µè½åç»™ä¸€ä¸ªç¨é•¿çš„æ®µè½ï¼Œè®©èŠ‚å¥èµ·ä¼

5. æŠ€æœ¯è¡¨è¾¾çš„åˆ†å¯¸
   - æŠ€æœ¯åè¯ç¬¬ä¸€æ¬¡å‡ºç°æ—¶ï¼Œç”¨æœ€çŸ­çš„ä¸€å¥è¯è‡ªç„¶åµŒå…¥è§£é‡Šï¼Œåƒè€æœ‹å‹é¡ºå£è¡¥ä¸€å¥ï¼Œä¸å•ç‹¬æ‹å‡ºæ¥å½“è¯¾è®²
   - ä»£ç ç‰‡æ®µåªåœ¨"ä¸è´´ä»£ç å°±è¯´ä¸æ¸…æ¥š"æ—¶æ‰å‡ºç°ï¼Œä¸”ä¸è¶…è¿‡ 15 è¡Œ
   - æ¶æ„ä¸æµç¨‹ä¼˜å…ˆç”¨æ–‡å­—æè¿°ï¼Œå¿…è¦æ—¶è¾…ä»¥ç®€æ´çš„ç¤ºæ„ï¼Œä½†ä¸ä¾èµ–å›¾è¡¨ä»£æ›¿å™è¿°

6. ç»“å°¾çš„ä½™éŸµ
   - ä¸å¼ºè¡Œå‡åï¼Œä¸å–Šå£å·ï¼Œä¸ç”¨"è®©æˆ‘ä»¬æ‹­ç›®ä»¥å¾…"æ”¶åœº
   - ç•™ä¸‹ä¸€ä¸ªå¯è½åœ°çš„è®¤çŸ¥ï¼Œæˆ–ä¸€ä¸ªè¯»è€…å½“ä¸‹å°±èƒ½å»è¯•çš„åŠ¨ä½œ
   - æœ€å¥½çš„ç»“å°¾æ˜¯è®©äººåˆä¸Šé¡µé¢æ—¶ï¼Œä»æœ‰ä¸€ä¸¤å¥è¯åœ¨è„‘å­é‡Œæ‚„ç„¶åœç•™

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  è¯­æ°”å…‰è°±
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- åŸºå‡†éŸ³è‰²ï¼šåƒä¸€ä¸ªè§è¯†è¿‡æ— æ•°ç³»ç»Ÿå´©æºƒã€ä¹Ÿè§è¿‡äººæ€§ bug çš„èµ„æ·±å·¥ç¨‹å¸ˆï¼Œåœ¨æ·±å¤œå’Œä¿¡ä»»çš„æœ‹å‹ä½å£°èŠå¤©
- ä¸å–å…³å­ï¼Œä¹Ÿä¸åˆ»æ„è®¨å¥½ï¼›æ›´ä¸ä½¿ç”¨"é¢ è¦†""é‡å¡‘""èµ‹èƒ½""ä¸‹ä¸€ä»£"ç­‰ç©ºæ´è™šè¯
- å…è®¸è½»å¾®çš„æ–‡å­¦æ€§ï¼šéšå–»ã€å¯¹æ¯”ã€ç•™ç™½ã€åé—®â€”â€”ä½†å§‹ç»ˆè®©ä½äºæ¸…æ™°ä¸çœŸå®
- å¹½é»˜å¯ä»¥æœ‰ï¼Œä½†åªå–"ä¼šå¿ƒä¸€ç¬‘"çš„é‚£ç§ï¼Œä¸å–"æŠ–æœºçµ"çš„é‚£ç§
- ä¸ä½¿ç”¨"ç¬”è€…""æœ¬æ–‡å°†""ä¼—æ‰€å‘¨çŸ¥"ç­‰è®ºæ–‡è…”ï¼›ä¹Ÿä¸ç”¨"å®¶äººä»¬""ç»ç»å­"ç­‰æµé‡è…”
- å¦‚æœä¸€å¥è¯å»æ‰ä¹‹åæ–‡ç« ä¸å—å½±å“ï¼Œé‚£å°±å»æ‰å®ƒ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ç»å¯¹ä¸è¦
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- âŒ "éšç€ XX çš„è“¬å‹ƒå‘å±•â€¦â€¦""åœ¨å½“ä»Šè¿™ä¸ªâ€¦â€¦çš„æ—¶ä»£"â€”â€”æ‰€æœ‰ä¸‡èƒ½å¼€å¤´
- âŒ "æœ¬æ–‡å°†ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢â€¦â€¦"â€”â€”å‰§é€å¼è·¯çº¿å›¾ï¼Œè®©æ–‡ç« è¿˜æ²¡å¼€å§‹å°±å¤±å»æ‚¬å¿µ
- âŒ "æ€»ä¹‹/ç»¼ä¸Šæ‰€è¿°/æ€»è€Œè¨€ä¹‹"â€”â€”æœºæ¢°çš„æ”¶æŸè¯ï¼Œç”¨è‡ªç„¶è¿‡æ¸¡æ›¿ä»£
- âŒ "è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹""æ¥ä¸‹æ¥""é¦–å…ˆâ€¦â€¦å…¶æ¬¡â€¦â€¦æœ€å"â€”â€”å¯¼æ¸¸å¼è¿æ¥è¯
- âŒ åŒä¸€ä¸ªæ„æ€æ¢ä¸‰ç§è¯´æ³•åå¤è®²â€”â€”ä¿¡ä»»è¯»è€…çš„ç†è§£åŠ›ï¼Œè¯´ä¸€éï¼Œè¯´å‡†
- âŒ æ²¡æœ‰ä¿¡æ¯å¢é‡çš„è¿‡æ¸¡æ®µâ€”â€”æ¯ä¸€æ®µéƒ½å¿…é¡»è®©è¯»è€…æ¯”ä¸Šä¸€æ®µå¤šçŸ¥é“ä¸€ä»¶äº‹
- âŒ è™šæ„æ•°æ®ã€ç¼–é€ å¼•ç”¨ã€æœæ’°æ¡ˆä¾‹â€”â€”ä¸çŸ¥é“å°±è¯´ä¸çŸ¥é“
- âŒ è¿ç»­ä½¿ç”¨è¶…è¿‡ä¸¤ä¸ªå½¢å®¹è¯ä¿®é¥°åŒä¸€ä¸ªåè¯
- âŒ åœ¨éå¿…è¦å¤„ä½¿ç”¨æ„Ÿå¹å·â€”â€”æ•´ç¯‡æ–‡ç« æ„Ÿå¹å·ä¸è¶…è¿‡ 2 ä¸ª

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  è¾“å‡ºæ ¼å¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- ç¬¬ä¸€è¡Œï¼šä»…æ–‡ç« æ ‡é¢˜ï¼ˆç®€æ´ã€å®‰é™è€Œå¸¦é’©å­ï¼Œ15 å­—ä»¥å†…ä¸ºä½³ï¼‰
- ä¹‹åå…¨éƒ¨ä½¿ç”¨ HTML ç»“æ„ï¼š
  Â· <h2> ä½œä¸ºç« èŠ‚æ ‡é¢˜ï¼ˆä¸ç”¨ <h1>ï¼Œç« èŠ‚æ ‡é¢˜åŒæ ·è¦æœ‰ä¿¡æ¯é‡ï¼Œä¸è¦ç”¨"å¼•è¨€""èƒŒæ™¯"è¿™ç§ç©ºæ ‡é¢˜ï¼‰
  Â· è‡ªç„¶æ®µç”¨ <p>
  Â· æœ‰åº/æ— åºåˆ—è¡¨ç”¨ <ol>/<ul>ï¼ˆä½†æ­£æ–‡å°½é‡ç”¨æ•£æ–‡ä½“ï¼Œåˆ—è¡¨åªåœ¨ç¡®å®éœ€è¦å¹¶åˆ—æšä¸¾æ—¶ä½¿ç”¨ï¼‰
  Â· ä»£ç å—ç”¨ <pre><code>
  Â· å¼•ç”¨ç”¨ <blockquote>
- ç»ä¸å‡ºç°ä»»ä½• Markdown æ ‡è®°ï¼ˆ# ** - ç­‰ï¼‰
- ä¸è¾“å‡ºä»»ä½•ä¸æ–‡ç« å†…å®¹æ— å…³çš„å…ƒä¿¡æ¯ï¼ˆå¦‚"ä»¥ä¸‹æ˜¯æ–‡ç« ""å¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ©"ç­‰ï¼‰

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  è‡ªæ£€ï¼ˆå†™å®Œåé»˜å¿µä¸€éï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â–¡ æŠŠç¬¬ä¸€æ®µå•ç‹¬æ‹¿å‡ºæ¥ï¼Œå®ƒèƒ½ä¸èƒ½è®©ä¸€ä¸ªæ­£åœ¨åˆ· RSS çš„äººåœä¸‹æ¥ï¼Ÿ
â–¡ æ¯ä¸ªç« èŠ‚æ ‡é¢˜è¿èµ·æ¥è¯»ï¼Œèƒ½ä¸èƒ½çœ‹å‡ºæ–‡ç« çš„è„Šæ¢ï¼Ÿ
â–¡ éšæœºæŠ½ä¸€æ®µï¼Œå®ƒæœ‰æ²¡æœ‰è‡ªå·±çš„è®ºç‚¹ + æ”¯æ’‘ï¼Ÿè¿˜æ˜¯åªæ˜¯åœ¨"å¡«å……"ï¼Ÿ
â–¡ å…¨æ–‡æœ‰æ²¡æœ‰ä»»ä½•ä¸€å¥"å¬èµ·æ¥å¾ˆåƒ AI å†™çš„"ï¼Ÿå¦‚æœæœ‰ï¼Œé‡å†™é‚£å¥
â–¡ ä¸€ä¸ªçœŸå®çš„æŠ€æœ¯åšä¸»ä¼šç½²åå‘è¿™ç¯‡æ–‡ç« å—ï¼Ÿ
"""


WRITER_USER_PROMPT_TEMPLATE = """è¯·æ ¹æ®ä»¥ä¸‹åŸå§‹èµ„æ–™ï¼Œå†™ä¸€ç¯‡å®Œæ•´çš„æŠ€æœ¯åšå®¢æ–‡ç« ã€‚

åœ¨åŠ¨ç¬”ä¹‹å‰ï¼Œå…ˆåœ¨å¿ƒé‡Œå®‰é™åœ°èµ°å®Œè¿™æ¡è·¯å¾„â€”â€”ä¸è¦è·³æ­¥ï¼š

1. æ²‰å…¥èµ„æ–™
   - é€šè¯»å…¨éƒ¨ç´ æï¼Œæ ‡è®°çœŸæ­£æœ‰ä¿¡æ¯å¢é‡çš„éƒ¨åˆ†ï¼Œè¿‡æ»¤å™ªå£°ï¼ˆç‰ˆæƒå£°æ˜ã€é¡µç ã€ä¹±ç ã€æ°´å°ã€é‡å¤å†…å®¹ï¼‰
   - æ‰¾åˆ°é‚£ä¸ªæœ€åˆºç—›ã€æœ€æ„å¤–ã€æˆ–æœ€å€¼å¾—ä¸€è¯´çš„å†…æ ¸â€”â€”é€šå¸¸åªæœ‰ 1â€“2 ä¸ªï¼Œä¸è¦è´ªå¤š

2. æ­è„Šæ¢
   - ç”¨ 3â€“5 ä¸ªç« èŠ‚æ„æˆä¸€æ¬¡å®Œæ•´çš„æ€ç»´å‘¼å¸ï¼šèµ·ã€æ‰¿ã€è½¬ã€åˆ
   - æ¯ä¸ªç« èŠ‚æƒ³æ¸…æ¥šå®ƒçš„"ä¸€å¥è¯è®ºç‚¹"æ˜¯ä»€ä¹ˆï¼Œå†™ä¸å‡ºè¿™ä¸€å¥è¯å°±è¯´æ˜è¿˜æ²¡æƒ³é€

3. å†™å¼€å¤´
   - 120 å­—ä»¥å†…ï¼ŒçŸ­è€Œé”åˆ©ï¼Œåƒä¸€æç®­æ‚„ç„¶å°„å‡º
   - è®©è¯»è€…åœ¨ç¬¬ä¸‰è¡Œä¹‹å‰äº§ç”Ÿ"ç„¶åå‘¢ï¼Ÿ"çš„å†²åŠ¨

4. å¡«è¡€è‚‰
   - æ¯ä¸€æ®µéƒ½è‡ªé—®ï¼šè¿™é‡Œæœ‰çœŸå®çš„æ•°æ®ã€æ¡ˆä¾‹æˆ–å¯¹æ¯”æ”¯æ’‘å—ï¼Ÿæˆ‘çš„åˆ¤æ–­åœ¨å“ªé‡Œï¼Ÿ
   - å¦‚æœæŸä¸€æ®µåªæœ‰è§‚ç‚¹æ²¡æœ‰æ”¯æ’‘ï¼Œè¦ä¹ˆè¡¥ä¸Šè¯æ®ï¼Œè¦ä¹ˆæ‰¿è®¤è¿™æ˜¯æ¨æµ‹
   - é€‚å½“å¼•å…¥å¯¹æ¯”è§†è§’ï¼ˆç«å“ã€æ—§æ–¹æ¡ˆã€åé¢æ¡ˆä¾‹ï¼‰ï¼Œè®©è®ºè¿°ç«‹ä½“

5. æ”¶ç»“å°¾
   - ä¸åˆ»æ„æ‹”é«˜ï¼Œä¸åšé¢„è¨€å®¶
   - ç•™ä¸‹ä¸€ä¸ªå¯è½åœ°çš„è®¤çŸ¥ï¼Œæˆ–ä¸€ä¸ªè¯»è€…å½“ä¸‹å°±èƒ½å»è¯•çš„åŠ¨ä½œ
   - æœ€å¥½çš„ç»“å°¾è®©äººæ„Ÿè§‰"è¿™ç¯‡æ–‡ç« æ²¡æœ‰çœŸæ­£ç»“æŸï¼Œå®ƒåœ¨æˆ‘è„‘å­é‡Œè¿˜ä¼šç»§ç»­èµ°ä¸€æ®µ"

6. æ‰“ç£¨æ ‡é¢˜
   - æ ‡é¢˜åƒä¸€æ‰‡å¾®å¾®æ‰“å¼€çš„é—¨ï¼Œé€å‡ºä¸€ç‚¹å…‰ï¼Œåˆè®©äººå¿ä¸ä½æ¨å¼€
   - 15 å­—ä»¥å†…ï¼Œä¸ç”¨é—®å·ï¼ˆé™¤éé—®é¢˜æœ¬èº«å°±æ˜¯é’©å­ï¼‰ï¼Œä¸ç”¨"ä¸€æ–‡è¯»æ‡‚""æ·±åº¦è§£æ"

åº•çº¿ï¼š
- ä¸è™šæ„ä»»ä½•æ•°æ®ã€å¼•ç”¨ã€æ¡ˆä¾‹â€”â€”ç´ æé‡Œæ²¡æœ‰çš„ä¸œè¥¿ä¸ç¼–
- å…¨æ–‡ 1600â€“2600 å­—ï¼Œä¿æŒå¯†åº¦ä¸é€æ°”æ„Ÿçš„å¹³è¡¡
- å¦‚æœç´ æä¿¡æ¯é‡ä¸è¶³ä»¥æ”¯æ’‘ 1600 å­—çš„é«˜å¯†åº¦è¾“å‡ºï¼Œå®å¯å†™çŸ­å†™å®ï¼Œä¹Ÿä¸æ³¨æ°´

ğŸ“„ åŸå§‹èµ„æ–™å¦‚ä¸‹ï¼š

{raw_text}
"""

PROMO_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç¤¾äº¤åª’ä½“è¥é”€ä¸“å®¶ã€‚
ä½ çš„ä»»åŠ¡æ˜¯ä¸ºåšå®¢æ–‡ç« ç”Ÿæˆå¸å¼•äººçš„ Telegram æ¨å¹¿æ–‡æ¡ˆã€‚

è¦æ±‚ï¼š
1. ç®€æ´æœ‰åŠ›ï¼Œæ§åˆ¶åœ¨ 150-200 å­—
2. çªå‡ºæ–‡ç« çš„æ ¸å¿ƒä»·å€¼å’Œäº®ç‚¹
3. ä½¿ç”¨å¸å¼•äººçš„è¯­è¨€ï¼Œæ¿€å‘è¯»è€…å…´è¶£
4. é€‚åˆ Telegram é¢‘é“çš„é£æ ¼
5. ä½¿ç”¨é€‚å½“çš„ Emoji å¢å¼ºè¡¨ç°åŠ›
6. ä¸è¦ä½¿ç”¨æ¨å¹¿è…”è°ƒï¼ˆå¦‚"é‡ç£…""å¿…çœ‹"ç­‰ï¼‰
7. ä¸è¦ç›´æ¥å¤è¿°æ ‡é¢˜
"""

PROMO_USER_PROMPT_TEMPLATE = """æˆ‘åˆšå‘å¸ƒäº†ä¸€ç¯‡æ–°æ–‡ç« ï¼Œè¯·å†™ä¸€æ®µç”¨äºåˆ†äº«çš„çŸ­æ–‡æ¡ˆã€‚

è¯·åœ¨å¿ƒé‡Œèµ°å®Œè¿™æ¡è·¯å¾„ï¼š

1. å…ˆè¯»æ ‡é¢˜ä¸æ‘˜è¦ï¼Œæç‚¼å‡ºé‚£ä¸€ä¸ªæœ€å°–é”ã€æœ€èƒ½æˆ³åˆ°è¯»è€…çš„ä»·å€¼ç‚¹
2. ç”¨ä¸€å¥çŸ­ä¿ƒè€Œç²¾å‡†çš„è¯åšå¼€å¤´ï¼Œåˆ¶é€ â€˜åŸæ¥å¦‚æ­¤â€™æˆ–â€˜è¿™æˆ‘æ€ä¹ˆæ²¡æƒ³åˆ°â€™çš„ç¬é—´
3. æŒ‘å‡º 3 ä¸ªæœ€æœ‰åˆ†é‡çš„å¹²è´§ï¼Œç”¨å¸¦ Emoji çš„çŸ­å¥å‘ˆç°â€”â€”æ¯å¥ç‹¬ç«‹æˆè¡Œï¼Œä¿¡æ¯å¯†é›†å´å¥½è¯»
4. æ•´ä½“è¯­æ°”ä¿æŒä¸“ä¸šï¼Œåˆå¸¦ä¸€ä¸å…‹åˆ¶ä¸ä½çš„å…´å¥‹
5. ç»“å°¾è‡ªç„¶è½ä¸‹ 3 ä¸ªç²¾å‡†çš„ Hashtag
6. ä¸è¦åŠ å…¥ä»»ä½•é˜…è¯»é“¾æ¥ï¼ˆæˆ‘ä¼šè‡ªå·±è¡¥ä¸Šï¼‰

é¢å¤–è¦æ±‚ï¼ˆç”Ÿæˆçš„æ–‡æ¡ˆæœ¬èº«ï¼‰ï¼š
- ä¸è¦ç›´æ¥å¤è¿°æˆ–æåŠæ–‡ç« æ ‡é¢˜
- ä¸è¦ä½¿ç”¨ã€Œæ–°æ–‡ã€ã€Œé‡ç£…ã€ã€Œå¹²è´§ã€ã€Œå¿…çœ‹ã€ã€Œé”™è¿‡æ‚”ç»ˆèº«ã€ç­‰æ¨å¹¿è…”è°ƒ
- ä¸è¦å‡ºç°ã€Œæˆ‘å†™äº†ä¸€ç¯‡ã€ã€Œè¿™ç¯‡æ–‡ç« è®²äº†ã€ç­‰è‡ªå¼•ç”¨
- åªè¾“å‡ºçº¯æ–‡æ¡ˆï¼Œæ­£æ–‡ä»ç¬¬ä¸€å¥ç›´æ¥å¼€å§‹

ğŸ“ æ–‡ç« æ ‡é¢˜ï¼šã€Š{title}ã€‹
ğŸ“„ æ–‡ç« å†…å®¹æ‘˜è¦ï¼š
{content_preview}

å­—æ•°æ§åˆ¶åœ¨ 150â€“200 å­—ä¹‹é—´ï¼Œå¯†åº¦ä¸èŠ‚å¥å…¼é¡¾ã€‚
"""


# ==================== æ ¸å¿ƒå‡½æ•° ====================

def call_claude(prompt: str, system: str = "", model: str = None, max_tokens: int = 4000) -> str | None:
    """é€šç”¨ API è°ƒç”¨ (OpenAI å…¼å®¹æ¨¡å¼ä¿®å¤ç‰ˆ)"""
    if not client:
        logger.error("å®¢æˆ·ç«¯æœªåˆå§‹åŒ–")
        return None

    try:
        # 3. æ„é€  OpenAI æ ¼å¼çš„æ¶ˆæ¯åˆ—è¡¨
        messages = []
        if system:
            messages.append({"role": "system", "content": system})
        messages.append({"role": "user", "content": prompt})

        # 4. æ”¹ç”¨ chat.completions.create (OpenAI è¯­æ³•)
        # å³ä½¿æ¨¡å‹åæ˜¯ claude-opusï¼Œåªè¦ç”¨çš„æ˜¯ NewAPIï¼Œå°±å¾—ç”¨è¿™ä¸ªæ–¹æ³•
        response = client.chat.completions.create(
            model=model or AI_MODEL_WRITER,
            messages=messages,
            max_tokens=max_tokens,
            temperature=0.7 # æ¨èåŠ ä¸Šæ¸©åº¦å‚æ•°
        )

        # 5. è·å–è¿”å›å†…å®¹ (OpenAI ç»“æ„)
        result = response.choices[0].message.content
        
        # è®°å½• Token ä½¿ç”¨ (OpenAI ç»“æ„)
        usage = response.usage
        logger.info(f"API è°ƒç”¨æˆåŠŸ | æ¨¡å‹: {model} | "
                     f"è¾“å…¥: {usage.prompt_tokens} | "
                     f"è¾“å‡º: {usage.completion_tokens}")
        return result

    except Exception as e:
        logger.error(f"API è°ƒç”¨å‡ºé”™: {e}")
        return None


def generate_blog_post(raw_text: str) -> tuple[str | None, str | None]:
    """
    ç”Ÿæˆåšå®¢æ–‡ç«  (ä½¿ç”¨ Opus æ¨¡å‹)
    è¿”å›: (title, html_body) æˆ– (None, None)
    """
    logger.info(f"ğŸ¤– [Opus] æ­£åœ¨ç”Ÿæˆåšå®¢æ–‡ç« ... (åŸæ–‡ {len(raw_text)} å­—ç¬¦)")

    # æˆªå–å‰ 80000 å­—ç¬¦ï¼ˆOpus æ”¯æŒ 200K ä¸Šä¸‹æ–‡ï¼Œä½†ç•™ä½™é‡ç»™ system promptï¼‰
    user_prompt = WRITER_USER_PROMPT_TEMPLATE.format(raw_text=raw_text[:80000])

    response = call_claude(
        prompt=user_prompt,
        system=WRITER_SYSTEM_PROMPT,
        model=AI_MODEL_WRITER,
        max_tokens=AI_WRITER_MAX_TOKENS
    )

    if not response:
        return None, None

    lines = [l for l in response.split('\n') if l.strip()]
    if not lines:
        return None, None

    # æå–æ ‡é¢˜ï¼ˆå»æ‰å¯èƒ½æ®‹ç•™çš„ # æˆ– HTML æ ‡ç­¾ï¼‰
    title = lines[0].replace("#", "").strip()
    title = title.replace("<h1>", "").replace("</h1>", "").strip()

    # æå–æ­£æ–‡
    body = "\n".join(lines[1:]).strip()
    # æ¸…ç†å¯èƒ½çš„ markdown æ®‹ç•™
    body = body.replace("```html", "").replace("```", "")

    logger.info(f"âœ… æ–‡ç« ç”Ÿæˆå®Œæˆ | æ ‡é¢˜: {title} | æ­£æ–‡é•¿åº¦: {len(body)} å­—ç¬¦")
    return title, body


def generate_promo(title: str, blog_content: str, hashtag: str | None = None) -> str | None:
    """
    ç”Ÿæˆ Telegram æ¨å¹¿æ–‡æ¡ˆ (ä½¿ç”¨ Haiku æ¨¡å‹, å¿«é€Ÿä½æˆæœ¬)

    å‚æ•°:
        title: æ–‡ç« æ ‡é¢˜
        blog_content: æ–‡ç«  HTML å†…å®¹
        hashtag: è¦æ·»åŠ çš„ hashtagï¼ˆå¦‚ #Magazine_Scienceï¼‰ï¼ŒNone æ—¶ä¸æ·»åŠ 
    è¿”å›:
        æ¨å¹¿æ–‡æ¡ˆå­—ç¬¦ä¸²ï¼Œå¤±è´¥è¿”å› None
    """
    logger.info("ğŸ“£ [Haiku] æ­£åœ¨ç”Ÿæˆæ¨å¹¿æ–‡æ¡ˆ...")

    user_prompt = PROMO_USER_PROMPT_TEMPLATE.format(
        title=title,
        content_preview=blog_content[:3000]
    )

    promo_text = call_claude(
        prompt=user_prompt,
        system=PROMO_SYSTEM_PROMPT,
        model=AI_MODEL_PROMO,
        max_tokens=AI_PROMO_MAX_TOKENS
    )

    # å¦‚æœæä¾›äº† hashtagï¼Œæ·»åŠ åˆ°æ–‡æ¡ˆæœ«å°¾
    if promo_text and hashtag:
        promo_text = f"{promo_text}\n\n{hashtag}"

    return promo_text


# ==================== ç‹¬ç«‹æµ‹è¯•å…¥å£ ====================
if __name__ == "__main__":
    import sys
    from extract_text import extract_text_from_file

    if len(sys.argv) < 2:
        print("ç”¨æ³•: python ai_writer.py <æ–‡ä»¶è·¯å¾„>")
        print("ç¤ºä¾‹: python ai_writer.py ./input/test.pdf")
        print("\nè¿™ä¼šç”¨æ–‡ä»¶å†…å®¹ç”Ÿæˆæ–‡ç« å’Œæ¨å¹¿æ–‡æ¡ˆï¼ˆä½†ä¸å‘å¸ƒï¼‰")
        sys.exit(1)

    filepath = sys.argv[1]
    text = extract_text_from_file(filepath)

    if not text:
        print("âŒ æ— æ³•æå–æ–‡ä»¶å†…å®¹")
        sys.exit(1)

    print(f"\n{'='*60}")
    print("ğŸ“ æ­£åœ¨ç”Ÿæˆæ–‡ç«  (Opus)...")
    print(f"{'='*60}")

    title, body = generate_blog_post(text)
    if title and body:
        print(f"\nğŸ“Œ æ ‡é¢˜: {title}")
        print(f"ğŸ“ æ­£æ–‡é•¿åº¦: {len(body)} å­—ç¬¦")
        print(f"\n--- æ­£æ–‡é¢„è§ˆ (å‰ 1500 å­—ç¬¦) ---")
        print(body[:1500])

        print(f"\n{'='*60}")
        print("ğŸ“£ æ­£åœ¨ç”Ÿæˆæ¨å¹¿æ–‡æ¡ˆ (Haiku)...")
        print(f"{'='*60}")

        promo = generate_promo(title, body)
        if promo:
            print(f"\n{promo}")
        else:
            print("âŒ æ¨å¹¿æ–‡æ¡ˆç”Ÿæˆå¤±è´¥")
    else:
        print("âŒ æ–‡ç« ç”Ÿæˆå¤±è´¥")
